# 系统架构设计

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 编写日期 | 2025-12-26 |
| 文档类型 | 系统架构设计 |

---

## 1. 整体架构

self-web-safiri 采用 Electron 框架，基于 Chromium 内核，使用 Vue 3 + TypeScript 构建前端界面。

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  主窗口UI   │  │  设置窗口   │  │  开发者工具  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      渲染进程 (Renderer)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  Vue 3 UI   │  │  Pinia状态  │  │ Vue Router  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  组件层     │  │  业务逻辑   │  │  工具函数   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │    IPC 通信       │
                    └─────────┬─────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      预加载脚本 (Preload)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  API 桥接   │  │  安全隔离   │  │  上下文注入  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       主进程 (Main)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  窗口管理   │  │  系统交互   │  │  生命周期   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  数据库管理 │  │  模块管理   │  │  IPC 处理器  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据存储层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  SQLite数据库│ │  IndexedDB  │  │  本地文件   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       外部服务层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  AI 服务    │  │  恶意网站检测│ │  更新服务    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 架构分层说明

### 2.1 用户界面层

| 组件 | 说明 |
|------|------|
| 主窗口UI | 浏览器主界面，包含地址栏、标签栏、内容区域 |
| 设置窗口 | 浏览器设置界面 |
| 开发者工具 | 调试和开发工具 |

### 2.2 渲染进程

| 组件 | 说明 |
|------|------|
| Vue 3 UI | 基于 Vue 3 的用户界面组件 |
| Pinia状态 | 应用状态管理 |
| Vue Router | 路由管理 |
| 组件层 | 可复用的UI组件 |
| 业务逻辑 | 业务逻辑处理 |
| 工具函数 | 通用工具函数 |

### 2.3 预加载脚本

| 组件 | 说明 |
|------|------|
| API桥接 | 桥接主进程和渲染进程的API |
| 安全隔离 | 隔离渲染进程和主进程的上下文 |
| 上下文注入 | 向渲染进程注入安全的API |

### 2.4 主进程

| 组件 | 说明 |
|------|------|
| 窗口管理 | 创建、管理、销毁窗口 |
| 系统交互 | 与操作系统交互（通知、文件系统等） |
| 生命周期 | 应用生命周期管理 |
| 数据库管理 | SQLite数据库操作 |
| 模块管理 | 功能模块管理 |
| IPC处理器 | 处理渲染进程的IPC请求 |

### 2.5 数据存储层

| 组件 | 说明 |
|------|------|
| SQLite数据库 | 持久化数据存储（用户配置、历史记录等） |
| IndexedDB | 临时数据存储（缓存、会话数据等） |
| 本地文件 | 文件存储（下载文件、导出配置等） |

### 2.6 外部服务层

| 组件 | 说明 |
|------|------|
| AI服务 | OpenAI/阿里云AI服务 |
| 恶意网站检测 | Google Safe Browsing API |
| 更新服务 | 应用更新检查和下载 |

---

## 3. 技术栈

### 3.1 核心框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Electron | 最新版 | 桌面应用框架 |
| Vue 3 | ^3.4.0 | 前端框架 |
| TypeScript | ^5.3.0 | 类型系统 |
| Vite | ^5.0.0 | 构建工具 |

### 3.2 UI框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Tailwind CSS | ^3.4.0 | CSS框架 |
| Element Plus | ^2.5.0 | UI组件库 |
| Pinia | ^2.1.0 | 状态管理 |
| Vue Router | ^4.2.0 | 路由管理 |

### 3.3 数据存储

| 技术 | 版本 | 用途 |
|------|------|------|
| better-sqlite3 | ^9.2.0 | SQLite数据库 |
| IndexedDB | 原生 | 浏览器本地存储 |
| crypto-js | ^4.2.0 | 数据加密 |

### 3.4 功能库

| 技术 | 版本 | 用途 |
|------|------|------|
| Readability | ^0.5.0 | 网页内容提取 |
| qrcode | ^1.5.0 | 二维码生成 |
| jsQR | ^1.4.0 | 二维码识别 |
| axios | ^1.6.0 | HTTP请求 |

### 3.5 开发工具

| 技术 | 版本 | 用途 |
|------|------|------|
| ESLint | ^8.56.0 | 代码检查 |
| Prettier | ^3.1.0 | 代码格式化 |
| electron-builder | ^24.9.0 | 打包构建 |

---

## 4. 目录结构

```
self-web-safiri/
├── src/
│   ├── main/                    # 主进程
│   │   ├── index.ts            # 主进程入口
│   │   ├── window/             # 窗口管理
│   │   ├── ipc/                # IPC处理器
│   │   ├── database/           # 数据库管理
│   │   ├── modules/            # 功能模块
│   │   └── utils/              # 工具函数
│   ├── preload/                # 预加载脚本
│   │   └── index.ts
│   ├── renderer/               # 渲染进程
│   │   ├── App.vue             # 根组件
│   │   ├── main.ts             # 渲染进程入口
│   │   ├── components/         # 组件
│   │   ├── views/              # 页面
│   │   ├── stores/             # 状态管理
│   │   ├── router/             # 路由
│   │   ├── api/                # API封装
│   │   └── utils/              # 工具函数
│   └── shared/                 # 共享代码
│       ├── types/              # 类型定义
│       └── constants/          # 常量定义
├── resources/                  # 资源文件
│   ├── icons/                  # 图标
│   └── images/                 # 图片
├── docs/                       # 文档
├── package.json
├── tsconfig.json
├── vite.config.ts
└── electron-builder.yml
```

---

## 5. 进程通信

### 5.1 IPC通信流程

```
渲染进程 (Renderer)          预加载脚本 (Preload)          主进程 (Main)
     │                              │                            │
     │  window.electronAPI.xxx()    │                            │
     ├─────────────────────────────►│                            │
     │                              │  ipcRenderer.invoke()     │
     │                              ├──────────────────────────►│
     │                              │                            │  处理请求
     │                              │                            │
     │                              │  返回结果                  │
     │                              │◄───────────────────────────┤
     │  返回Promise结果             │                            │
     │◄─────────────────────────────┤                            │
```

### 5.2 通信方式

| 类型 | 说明 | 使用场景 |
|------|------|----------|
| invoke | 请求-响应模式 | 需要返回结果的调用 |
| send | 单向发送 | 事件通知 |
| on | 监听事件 | 接收主进程事件 |

---

## 6. 安全设计

### 6.1 进程隔离

- 渲染进程与主进程完全隔离
- 通过预加载脚本进行安全通信
- 禁止渲染进程直接访问Node.js API

### 6.2 数据加密

- 敏感数据使用AES加密存储
- 配置文件加密保护
- 数据库连接加密

### 6.3 权限控制

- 插件权限管理
- 文件系统访问限制
- 网络请求控制

---

## 7. 性能优化

### 7.1 渲染优化

- 虚拟滚动列表
- 组件懒加载
- 图片懒加载

### 7.2 内存优化

- 标签页内存回收
- 缓存清理策略
- 历史记录限制

### 7.3 启动优化

- 按需加载模块
- 预加载关键资源
- 延迟初始化服务
